(this["webpackJsonpwebrtc-chat"]=this["webpackJsonpwebrtc-chat"]||[]).push([[0],{46:function(e,t,n){},47:function(e,t,n){},80:function(e,t,n){},82:function(e,t,n){},83:function(e,t,n){},84:function(e,t,n){},85:function(e,t,n){},86:function(e,t,n){},87:function(e,t,n){},88:function(e,t,n){},89:function(e,t,n){"use strict";n.r(t);var c=n(1),r=n.n(c),o=n(40),s=n.n(o),a=(n(46),n(2)),i=(n(47),n(5)),u=n.n(i),l=n(16),d=n(3),f=n(4),h=n(12),v=n(11),j=n(41),m=new(function(){function e(){Object(d.a)(this,e),this._eventListeners={},this._user={id:"",name:"",room:this.roomId}}return Object(f.a)(e,[{key:"localStream",get:function(){return this._localStream},set:function(e){this._localStream=e}},{key:"user",get:function(){return this._user},set:function(e){this._user=e,console.log("Logged",this._user)}},{key:"roomId",get:function(){if(void 0===this._user||void 0===this._user.room){var e=new URL(window.location.href),t=new URLSearchParams(e.search),n=t.get("room");return n||(n=function(){var e=function(){return Math.floor(65536*Math.random()).toString(16)};return"".concat(e()).concat(e(),"-").concat(e(),"-").concat(e(),"-").concat(e(),"-").concat(e()).concat(e()).concat(e())}(),t.append("room",n),window.location.search=t),n}return this._user.room}}]),e}()),b=function(){function e(){Object(d.a)(this,e),this._eventListeners={}}return Object(f.a)(e,[{key:"addEventListener",value:function(e,t){void 0===this._eventListeners[e]&&(this._eventListeners[e]=[]),this._eventListeners[e].push(t)}},{key:"removeEventListener",value:function(e,t){this._eventListeners[e]=this._eventListeners[e].filter((function(e){return e.toString()!==t.toString()}))}}]),e}(),O=new(function(e){Object(h.a)(n,e);var t=Object(v.a)(n);function n(){var e;return Object(d.a)(this,n),(e=t.call(this))._eventListeners={},e._log=[],e}return Object(f.a)(n,[{key:"log",get:function(){return this._log}},{key:"push",value:function(e){var t,n,c=this;e.data.time=new Date(e.data.time),this._log.push(e),null===(t=this._eventListeners.newMessage)||void 0===t||t.forEach((function(t){return t(e)})),null===(n=this._eventListeners.newMessages)||void 0===n||n.forEach((function(e){return e(c._log)}))}}]),n}(b)),g=new(function(e){Object(h.a)(n,e);var t=Object(v.a)(n);function n(){var e;return Object(d.a)(this,n),(e=t.call(this)).onConnect=function(t){var n;null===(n=e._eventListeners.connectionChange)||void 0===n||n.forEach((function(t){t(e.socket.connected)}))},e.onError=function(t){var n;null===(n=e._eventListeners.error)||void 0===n||n.forEach((function(e){e(t)}))},e.onLogged=function(t){var n;null===(n=e._eventListeners.logged)||void 0===n||n.forEach((function(e){e(t)}))},e.onRoomData=function(t){var n;null===(n=e._eventListeners.usersChange)||void 0===n||n.forEach((function(e){e(t.users)}))},e.onBeforeUnload=function(){e.socket.emit("disconnect")},e.onMessage=function(e){O.push(e)},e.sendNewMessage=function(e){g.socket.emit("sendMessage",{text:e})},e.sendRTCOverSocket=function(e,t,n){g.socket.emit("webrtc",{id:m.user.id,to:e,type:t,data:n})},e._eventListeners={},e.socket=Object(j.io)("https://webrtc-chat-api.herokuapp.com/",{reconnectionDelayMax:1e4}),e.socket.on("connect",e.onConnect),e.socket.on("disconnect",e.onConnect),e}return Object(f.a)(n,[{key:"connect",value:function(e){var t=e.user,n=e.room;this.socket.connected&&(this.socket.on("webrtc",_),this.socket.on("webrtc_new_peer",k),this.socket.on("roomData",this.onRoomData),this.socket.on("message",this.onMessage),this.socket.on("logged",this.onLogged),this.socket.on("error",this.onError),this.socket.emit("join",JSON.stringify({username:t,room:n})))}}]),n}(b)),p=new(function(e){Object(h.a)(n,e);var t=Object(v.a)(n);function n(){var e;return Object(d.a)(this,n),(e=t.call(this))._id=null,e._localStream=void 0,e.getUserMedia().then((function(t){e._localStream=t})).catch((function(e){return console.error("Error get user media",e)})),e._streams={},e}return Object(f.a)(n,[{key:"localId",get:function(){return this._id},set:function(e){this._id=e,this.addStream(e,this._localStream)}},{key:"localStream",get:function(){return this._localStream}},{key:"getUserMedia",value:function(){return navigator.mediaDevices.getUserMedia({video:!0,audio:!0})}},{key:"addStream",value:function(e,t){var n,c=this;this._streams[e]=t,null===(n=this._eventListeners["streamAdded-".concat(e)])||void 0===n||n.forEach((function(t){void 0!==c._streams[e]&&t(c._streams[e])})),this._id===e&&(this._localStream=this._streams[e])}},{key:"getAudioTrack",value:function(e,t){var n;if(void 0!==this._streams[e]){switch(t){case"audio":n=this._streams[e].getAudioTracks()[0];break;case"video":n=this._streams[e].getVideoTracks()[0];break;default:return void console.warn("Unknown stream type",t)}return n}console.warn("Stream doesn't exist",e)}},{key:"getState",value:function(e,t){var n;return null!==(n=this.getAudioTrack(e,t))&&void 0!==n?n:{enabled:!1}}},{key:"toggleStream",value:function(e,t){var n,c=this,r=this.getAudioTrack(e,t);void 0!==r&&(r.enabled=!r.enabled,null===(n=this._eventListeners["streamToggled-".concat(e)])||void 0===n||n.forEach((function(t){void 0!==c._streams[e]&&t(c._streams[e])})));return null!==r&&void 0!==r?r:{enabled:!1}}},{key:"removeStream",value:function(e){void 0!==this._streams[e]&&delete this._streams[e]}},{key:"getStream",value:function(e){return console.log(e),console.log(this._streams),console.log(this._streams[e]),this._streams[e]}}]),n}(b)),x=new(function(e){Object(h.a)(n,e);var t=Object(v.a)(n);function n(){var e;return Object(d.a)(this,n),(e=t.call(this)).onBeforeUnload=function(){for(var e in x.peers)if(x.peers.hasOwnProperty(e)&&void 0!==x.peers[e].channel)try{x.peers[e].channel.close()}catch(t){console.error(t)}},e._eventListeners={},e._connectionsCount=0,e.peers={},e.server={iceServers:[{url:"turn:webrtc-chat-api.herokuapp.com:3478",username:"turnclient",credential:"$0mep@$$w0rd"},{url:"stun:webrtc-chat-api.herokuapp.com"},{url:"turn:217.150.77.131:3478",username:"turnclient",credential:"$0mep@$$w0rd"},{url:"stun:217.150.77.131:3478"},{url:"stun:stun.l.google.com:19302"},{url:"stun:stun.l.google.com:19302"},{url:"stun:stun1.l.google.com:19302"}]},e}return Object(f.a)(n,[{key:"connectionsCount",get:function(){return this._connectionsCount},set:function(e){var t,n=this;this._connectionsCount=e,null===(t=this._eventListeners.connectionsChange)||void 0===t||t.forEach((function(e){e({count:n._connectionsCount,peers:n.peers.keys})}))}}]),n}(b));function k(e){return w.apply(this,arguments)}function w(){return(w=Object(l.a)(u.a.mark((function e(t){var n,c,r,o;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.user,c=t.data,"SERVER"===n){e.next=3;break}return e.abrupt("return");case 3:return r=c.id,c.name,c.room,console.log("Creating new peer",[n,c]),D(r),o=x.peers[r].connection,E(r,o),e.next=10,L(r,o);case 10:return e.next=12,o.createOffer().then((function(e){return o.setLocalDescription(e).then((function(){g.sendRTCOverSocket(r,"offer",e)})).catch((function(e){return console.error("Error set local description",e)}))})).catch((function(e){return console.error("Error create offer",e)}));case 12:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function _(e){var t=e.id,n=e.to,c=e.type,r=e.data;switch(c){case"candidate":!function(e,t){C.apply(this,arguments)}(t,r);break;case"offer":!function(e,t){S.apply(this,arguments)}(t,r);break;case"answer":!function(e,t){y.apply(this,arguments)}(t,r);break;default:console.log("Unknown type received from socket:"),console.log({id:t,to:n,type:c,data:r})}}function y(){return(y=Object(l.a)(u.a.mark((function e(t,n){var c;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return c=x.peers[t].connection,e.next=3,c.setRemoteDescription(n).catch((function(e){return console.error("Error set remote description",e)}));case 3:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function C(){return(C=Object(l.a)(u.a.mark((function e(t,n){var c;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return D(t),c=x.peers[t].connection,e.next=4,c.addIceCandidate(n).catch((function(e){return console.error("Error add iceCandidate",e)}));case 4:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function S(){return(S=Object(l.a)(u.a.mark((function e(t,n){var c;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return D(t),c=x.peers[t].connection,e.next=4,L(t,c);case 4:return E(t,c),e.next=7,c.setRemoteDescription(n).then((function(){c.createAnswer().then((function(e){return c.setLocalDescription(e).then((function(){g.sendRTCOverSocket(t,"answer",e)})).catch((function(e){return console.error("Error set local description",e)}))})).catch((function(e){return console.error("Error create answer",e)}))})).catch((function(e){return console.error("Error set remote description",e)}));case 7:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function E(e,t){t.onicecandidate=function(t){t.candidate&&g.sendRTCOverSocket(e,"candidate",t.candidate)},t.oniceconnectionstatechange=function(n){switch(t.iceConnectionState){case"disconnected":delete x.peers[e],p.removeStream(e),x.connectionsCount=x.connectionsCount-1,console.log("[".concat(e,"] disconnected! Peers: ").concat(x.connectionsCount));break;case"connected":x.connectionsCount=x.connectionsCount+1,console.log("[".concat(e,"] connected! Peers: ").concat(x.connectionsCount));break;default:console.log(t.iceConnectionState)}}}function L(e,t){return N.apply(this,arguments)}function N(){return(N=Object(l.a)(u.a.mark((function e(t,n){return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n.ontrack=function(e){var n=Object(a.a)(e.streams,1)[0];p.addStream(t,n)},void 0!==p.localStream&&p.localStream.getTracks().forEach((function(e){n.addTrack(e,p.localStream)}));case 2:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function D(e){void 0===x.peers[e]&&(x.peers[e]={},x.peers[e].connection=new RTCPeerConnection(x.server))}n(80);var T=n(0);function M(){var e=Object(c.useState)(""),t=Object(a.a)(e,2),n=t[0],r=t[1],o=Object(c.useState)(""),s=Object(a.a)(o,2),i=s[0],u=s[1],l=Object(c.useState)(""),d=Object(a.a)(l,2),f=d[0],h=d[1];Object(c.useEffect)((function(){return g.addEventListener("error",v),g.addEventListener("connectionChange",j),function(){g.removeEventListener("error",v),g.removeEventListener("connectionChange",j)}}),[]);var v=function(e){switch(e.type){case"addUser":u(e.error)}},j=function(e){h(e)},b=function(e){g.connect({user:n,room:m.user.room})};return Object(T.jsx)("div",{className:"Login",children:Object(T.jsxs)("div",{className:"login-container",children:[Object(T.jsxs)("div",{className:"login-info-container",children:[Object(T.jsx)("label",{htmlFor:"uname",children:Object(T.jsx)("b",{children:"Username"})}),Object(T.jsx)("label",{className:"info-connected",style:{color:f?"#B1D9CD":"#FDB196"},children:Object(T.jsx)("b",{children:f?"Connected":"Disconnected"})})]}),Object(T.jsx)("input",{type:"text",placeholder:"Enter Username",onChange:function(e){r(e.target.value)},onKeyDown:function(e){13===e.keyCode&&b()},required:!0}),Object(T.jsx)("div",{className:"login-error",children:i}),Object(T.jsx)("button",{type:"submit",onClick:b,children:"Login"})]})})}var U=n(15);n(82);function R(){var e=Object(c.useState)([]),t=Object(a.a)(e,2),n=t[0],r=t[1];Object(c.useEffect)((function(){return g.addEventListener("usersChange",o),function(){g.removeEventListener("usersChange",o)}}),[]);var o=function(e){r(Object(U.a)(e))};return Object(T.jsx)("div",{className:"UsersList",children:Object(T.jsx)("div",{className:"users-list-container",children:Object(T.jsx)("ol",{className:"users-list",children:n.map((function(e){return Object(T.jsxs)("li",{className:"list-item",children:[Object(T.jsx)("div",{className:"user-item-gradient"}),Object(T.jsx)("div",{className:"user-item-content",children:Object(T.jsx)("h4",{children:"".concat(e.name)})})]},e.id)}))})})})}n(83),n(84);function B(e){var t=e.videoId,n=e.title,r=e.type,o=e.onClick,s=Object(c.useRef)(null);Object(c.useEffect)((function(){return p.addEventListener("streamAdded-".concat(t),a),p.addEventListener("streamToggled-".concat(t),i),null!==s&&(s.current.srcObject=p.getStream(t),console.log([t,p.getStream(t),p._streams])),function(){p.removeEventListener("streamAdded-".concat(t),a),p.removeEventListener("streamToggled-".concat(t),i)}}),[]);var a=function(e){null!==s&&(s.current.srcObject=e)},i=function(e){null!==s&&(s.current.srcObject=e)};return Object(T.jsxs)("article",{className:"video-listing",children:[Object(T.jsx)("div",{onClick:function(e){o(e)},id:"title-".concat(t),className:"video-title",children:n}),Object(T.jsx)("div",{className:"video-container",children:Object(T.jsx)("video",{ref:s,autoPlay:!0,muted:"local"===r,className:"".concat(r,"-video"),id:"video-".concat(t)})})]},"article-".concat(t))}var I=n.p+"static/media/camera.53281603.svg",A=n.p+"static/media/microphone.b5ad8492.svg";n(85);function F(){var e=Object(c.useState)(p.getState(p.localId,"video").enabled),t=Object(a.a)(e,2),n=t[0],r=t[1],o=Object(c.useState)(p.getState(p.localId,"audio").enabled),s=Object(a.a)(o,2),i=s[0],u=s[1];return Object(T.jsx)("div",{className:"StreamControls",children:Object(T.jsxs)("div",{className:"controls-container",children:[Object(T.jsx)("div",{style:{backgroundColor:n?"#B1D9CD":"#FDB196"},className:"round-container",onClick:function(){r(p.toggleStream(p.localId,"video").enabled)},children:Object(T.jsx)("img",{src:I,alt:"camera icon"})}),Object(T.jsx)("div",{style:{backgroundColor:i?"#B1D9CD":"#FDB196"},className:"round-container",onClick:function(){u(p.toggleStream(p.localId,"audio").enabled)},children:Object(T.jsx)("img",{src:A,alt:"microphone icon"})})]})})}function P(){var e=Object(c.useState)([]),t=Object(a.a)(e,2),n=t[0],r=t[1],o=Object(c.useRef)(null);Object(c.useEffect)((function(){return g.addEventListener("usersChange",s),function(){g.removeEventListener("usersChange",s)}}),[]);var s=function(e){r(Object(U.a)(e))},i=function(e){o.current.srcObject=document.getElementById("video-".concat(e.target.id.substr(6))).srcObject};return Object(T.jsxs)("div",{className:"VideoGrid",children:[Object(T.jsxs)("div",{className:"video-row-container",children:[Object(T.jsx)(B,{title:m.user.name,videoId:m.user.id,onClick:i,type:"local"}),n.filter((function(e){return e.id!==m.user.id})).map((function(e){return Object(T.jsx)(B,{title:e.name,videoId:e.id,onClick:i,type:"remote"},"video-".concat(e.id))}))]}),Object(T.jsx)("div",{className:"selected-video-container",children:Object(T.jsx)("video",{ref:o,autoPlay:!0,muted:!0,className:"selected-video",id:"selected-video"})}),Object(T.jsx)("div",{className:"stream-controls-container",children:Object(T.jsx)(F,{})})]})}n(86),n(87);function $(){var e=Object(c.useState)([]),t=Object(a.a)(e,2),n=t[0],r=t[1];Object(c.useEffect)((function(){return O.addEventListener("newMessage",o),function(){O.removeEventListener("newMessage",o)}}),[]);var o=function(e){r((function(t){return[].concat(Object(U.a)(t),[e])}))};return Object(T.jsx)("div",{className:"ChatHistory",children:Object(T.jsx)("div",{className:"chat-history-container",children:n.map((function(e,t){return Object(T.jsxs)("div",{children:[Object(T.jsxs)("div",{className:"info-container",children:[Object(T.jsx)("div",{className:"user",children:"".concat(e.user)}),Object(T.jsx)("div",{className:"time",children:(n=e.data.time,"".concat(("0"+n.getHours()).substr(-2),":").concat(("0"+n.getMinutes()).substr(-2)))})]}),Object(T.jsx)("span",{style:{whiteSpace:"pre-line"},className:"message",children:"".concat(e.data.text)})]},t);var n}))})})}n(88);function H(){var e=Object(c.useRef)(null),t=Object(c.useState)(""),n=Object(a.a)(t,2),r=n[0],o=n[1],s=Object(c.useState)("auto"),i=Object(a.a)(s,2),u=i[0],l=i[1];Object(c.useEffect)((function(){l("".concat(e.current.scrollHeight+2,"px"))}),[r]);var d=function(){var e=r.trim();0!==e.length&&(g.sendNewMessage(e),o(""),l("auto"))};return Object(T.jsx)("div",{className:"AutoTextArea",children:Object(T.jsxs)("div",{className:"text-area-container",children:[Object(T.jsx)("textarea",{className:"auto-text-area",ref:e,rows:1,style:{height:u,flexGrow:1},value:r,onChange:function(e){l("auto"),o(e.target.value),console.log(r.split("\r\n"))},onKeyDown:function(e){e.shiftKey||13!==e.keyCode||(d(),e.preventDefault())}}),Object(T.jsx)("button",{onClick:d,children:"Send"})]})})}function J(){return Object(T.jsxs)("div",{className:"Chat",children:[Object(T.jsx)($,{}),Object(T.jsx)(H,{})]})}var K=function(){var e=Object(c.useState)(!1),t=Object(a.a)(e,2),n=t[0],r=t[1],o=function(e){m.user=e.data,p.localId=e.data.id,r(!0)};return Object(c.useEffect)((function(){if(g.addEventListener("logged",o),n)return window.addEventListener("beforeunload",g.onBeforeUnload),window.addEventListener("beforeunload",x.onBeforeUnload),function(){g.removeEventListener("logged",o),window.removeEventListener("beforeunload",x.onBeforeUnload),window.removeEventListener("beforeunload",g.onBeforeUnload)}}),[n]),Object(T.jsxs)("div",{className:"App",children:[" ",n?Object(T.jsx)(T.Fragment,{children:Object(T.jsx)(T.Fragment,{children:Object(T.jsxs)("div",{className:"App-body",children:[Object(T.jsx)("div",{className:"video-grid-container",children:Object(T.jsx)(P,{})}),Object(T.jsxs)("div",{className:"info-chat-container",children:[Object(T.jsx)(R,{}),Object(T.jsx)(J,{})]})]})})}):Object(T.jsx)(M,{})]})},V=function(e){e&&e instanceof Function&&n.e(3).then(n.bind(null,90)).then((function(t){var n=t.getCLS,c=t.getFID,r=t.getFCP,o=t.getLCP,s=t.getTTFB;n(e),c(e),r(e),o(e),s(e)}))};s.a.render(Object(T.jsx)(r.a.StrictMode,{children:Object(T.jsx)(K,{})}),document.getElementById("root")),V()}},[[89,1,2]]]);
//# sourceMappingURL=main.5bff9c84.chunk.js.map